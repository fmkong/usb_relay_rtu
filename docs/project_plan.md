# USB继电器RTU控制软件项目规划

## 项目概述

基于Modbus RTU协议手册，开发一个跨平台（Ubuntu/Windows）的命令行软件，用于控制USB继电器模块和读取数字量输入。

## 协议分析

### 支持的功能码
- **01H**: 读线圈寄存器（读继电器状态）
- **02H**: 读离散输入寄存器（读数字量输入状态）  
- **03H**: 读保持寄存器
- **04H**: 读输入寄存器
- **05H**: 写单个线圈寄存器（控制单个继电器）
- **06H**: 写单个保持寄存器
- **0FH**: 写多个线圈寄存器（控制多个继电器）
- **10H**: 写多个保持寄存器

### 寄存器映射
- **线圈状态** (00001-09999): 继电器输出控制
- **离散输入状态** (10001-19999): 数字量输入状态
- **保持寄存器** (40001-49999): 配置参数
- **输入寄存器** (30001-39999): 状态信息

### 通信参数
- 协议: Modbus RTU
- 接口: USB转串口
- 数据格式: 8位数据位，1位停止位，无校验位
- CRC16校验

## 软件架构设计

### 核心模块
1. **ModbusRTU通信模块** (`modbus_rtu.py`)
   - CRC16校验计算
   - 数据帧封装/解析
   - 串口通信管理

2. **设备控制模块** (`device_controller.py`)
   - 继电器控制接口
   - 数字量输入读取
   - 设备状态管理

3. **命令行接口** (`cli.py`)
   - 参数解析
   - 用户交互
   - 输出格式化

4. **配置管理** (`config.py`)
   - 设备配置
   - 通信参数设置

### 项目结构
```
usb_relay_rtu/
├── src/
│   ├── __init__.py
│   ├── modbus_rtu.py       # Modbus RTU协议实现
│   ├── device_controller.py # 设备控制接口
│   ├── cli.py              # 命令行接口
│   ├── config.py           # 配置管理
│   └── utils.py            # 工具函数
├── docs/
│   ├── project_plan.md     # 项目规划
│   ├── api_reference.md    # API参考文档
│   └── user_guide.md       # 用户指南
├── tests/
│   └── test_*.py           # 单元测试
├── requirements.txt        # Python依赖
├── setup.py               # 安装脚本
└── README.md              # 项目说明
```

## 功能需求

### 基础功能
1. **继电器控制**
   - 打开/关闭单个继电器
   - 批量控制多个继电器
   - 读取继电器当前状态

2. **数字量输入**
   - 读取单个输入状态
   - 批量读取多个输入状态
   - 实时监控输入变化

3. **设备管理**
   - 自动检测USB串口设备
   - 设备连接状态检查
   - 支持多设备管理

### 命令行界面
```bash
# 继电器控制
usb-relay set-relay --device /dev/ttyUSB0 --relay 1 --state on
usb-relay set-relay --device COM3 --relay 1,2,3 --state off

# 读取继电器状态
usb-relay get-relay --device /dev/ttyUSB0 --relay 1
usb-relay get-relay --device /dev/ttyUSB0 --relay all

# 读取数字量输入
usb-relay get-input --device /dev/ttyUSB0 --input 1
usb-relay get-input --device /dev/ttyUSB0 --input all

# 设备信息
usb-relay list-devices
usb-relay device-info --device /dev/ttyUSB0
```

## 技术选型

### 开发语言
- **Python 3.8+**: 跨平台支持，丰富的串口通信库

### 主要依赖
- **pyserial**: 串口通信
- **click**: 命令行接口框架
- **rich**: 美化终端输出
- **pyyaml**: 配置文件解析

### 跨平台兼容性
- 自动检测操作系统类型
- 适配不同平台的串口设备命名规则
- 统一的安装和使用方式

## 开发阶段

### 阶段1: 核心协议实现
- [x] 分析Modbus RTU协议文档
- [ ] 实现CRC16校验算法
- [ ] 实现基础Modbus RTU通信
- [ ] 串口连接和数据收发

### 阶段2: 设备控制功能
- [ ] 继电器控制接口
- [ ] 数字量输入读取
- [ ] 设备状态管理

### 阶段3: 命令行接口
- [ ] 参数解析和验证
- [ ] 用户友好的输出格式
- [ ] 错误处理和提示

### 阶段4: 测试和优化
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能优化
- [ ] 文档完善

### 阶段5: 打包和发布
- [ ] 跨平台打包
- [ ] 安装脚本
- [ ] 用户文档

## 当前状态

**日期**: 2024-09-15
**状态**: 核心功能开发完成
**进度**: 已完成所有核心模块开发，项目基本可用

### 已完成
- [x] Modbus RTU协议文档分析
- [x] 项目架构设计
- [x] 技术选型确定
- [x] 项目规划文档创建
- [x] 创建项目基础结构
- [x] 实现CRC16校验算法
- [x] 实现基础Modbus RTU通信模块
- [x] 开发串口通信接口
- [x] 实现设备控制模块
- [x] 开发命令行接口
- [x] 实现配置管理模块
- [x] 创建工具函数模块
- [x] 编写项目文档
- [x] 创建安装脚本

### 阶段1完成情况: 核心协议实现
- [x] 分析Modbus RTU协议文档
- [x] 实现CRC16校验算法
- [x] 实现基础Modbus RTU通信
- [x] 串口连接和数据收发

### 阶段2完成情况: 设备控制功能
- [x] 继电器控制接口
- [x] 数字量输入读取
- [x] 设备状态管理

### 阶段3完成情况: 命令行接口
- [x] 参数解析和验证
- [x] 用户友好的输出格式
- [x] 错误处理和提示

### 已完成 - 阶段4: 测试和验证
- [x] 核心功能单元测试（4/4通过）
- [x] 实际硬件集成测试
- [x] CRC16算法验证（协议手册标准）
- [x] 设备连接和通信测试
- [x] 继电器控制功能验证
- [x] 数字量输入读取验证
- [x] 高级功能测试（脉冲控制、流水灯）
- [x] 跨平台兼容性验证
- [x] 文档完善

### 已完成 - 阶段5: 发布准备
- [x] 完整项目文档
- [x] 用户指南和API参考
- [x] 安装脚本和依赖管理
- [x] 功能演示脚本
- [x] 核心测试脚本

### 项目完成状态: 100%
✅ 所有预定目标已完成
✅ 实际硬件测试通过
✅ 软件功能完全可用
